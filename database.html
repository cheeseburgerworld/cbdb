<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database â€” CBâš¡DB</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=IBM+Plex+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-text-size-adjust: 100%; }

    :root {
        --bg:     #0d0900;
        --bg2:    #110e08;
        --amber:  #FF8C00;
        --adim:   #7A4200;
        --afaint: #1e1408;
        --green:  #39FF14;
        --gold:   #FFD000;
        --w:      #ffffff;
        --wd:     rgba(255,255,255,0.75);
        --fhead:  'Bebas Neue', 'Arial Black', Impact, sans-serif;
        --fbody:  'IBM Plex Mono', 'Courier New', monospace;
    }

    body { background: var(--bg); color: var(--w); font-family: var(--fbody); min-height: 100vh; }

    /* NAV */
    nav {
        position: sticky; top: 0; z-index: 100; height: 52px;
        background: rgba(13,9,0,0.96);
        -webkit-backdrop-filter: blur(12px); backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--afaint);
        display: flex; align-items: center; justify-content: space-between;
        padding: 0 16px; gap: 12px;
    }
    .logo { font-family: var(--fhead); font-size: 22px; letter-spacing: 3px; color: var(--amber); text-decoration: none; flex-shrink: 0; line-height: 1; }
    .logo .bolt { color: var(--green); }
    .nav-links { display: flex; align-items: center; gap: 2px; list-style: none; }
    .nav-links a { font-size: 10px; letter-spacing: 1.5px; text-transform: uppercase; color: var(--adim); text-decoration: none; padding: 6px 10px; white-space: nowrap; transition: color 0.15s; }
    .nav-links a:hover { color: var(--w); }
    .nav-links .active { color: var(--amber); }
    .nav-links .pill { border: 1px solid var(--green); color: var(--green) !important; }
    .nav-links .pill:hover { background: rgba(57,255,20,0.08); }
    @media (max-width: 600px) { .nav-links .hide { display: none; } }

    /* PAGE HEADER */
    .page-head {
        padding: 32px 20px 24px;
        max-width: 1100px; margin: 0 auto;
        border-bottom: 1px solid var(--afaint);
        display: flex; align-items: flex-end; justify-content: space-between; gap: 16px; flex-wrap: wrap;
    }
    .eyebrow { font-size: 9px; letter-spacing: 4px; color: var(--green); text-transform: uppercase; margin-bottom: 8px; }
    .page-title { font-family: var(--fhead); font-size: clamp(36px, 8vw, 60px); color: var(--amber); letter-spacing: 3px; line-height: 1; }
    .live-badge {
        display: flex; align-items: center; gap: 6px;
        font-size: 9px; letter-spacing: 2px; text-transform: uppercase; color: var(--green);
        padding-bottom: 4px;
    }
    .live-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse {
        0%,100% { box-shadow: 0 0 0 0 rgba(57,255,20,.5); }
        50%      { box-shadow: 0 0 0 6px rgba(57,255,20,0); }
    }

    /* FILTER BAR */
    .filter-bar {
        padding: 12px 20px;
        max-width: 1100px; margin: 0 auto;
        display: flex; gap: 6px; flex-wrap: wrap; align-items: center;
        border-bottom: 1px solid var(--afaint);
    }
    .filter-label { font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: var(--adim); margin-right: 2px; white-space: nowrap; }
    .fbtn {
        font-family: var(--fbody); font-size: 9px; letter-spacing: 1.5px; text-transform: uppercase;
        background: transparent; border: 1px solid var(--afaint); color: rgba(255,255,255,0.5);
        padding: 5px 11px; cursor: pointer; transition: all 0.15s; white-space: nowrap;
    }
    .fbtn:hover { border-color: var(--adim); color: var(--w); }
    .fbtn.on  { font-weight: 700; }
    .fall.on  { background: var(--amber); border-color: var(--amber); color: var(--bg); }
    .f3.on    { background: #39FF14; border-color: #39FF14; color: var(--bg); }
    .f2.on    { background: #FFD000; border-color: #FFD000; color: var(--bg); }
    .f1.on    { background: #FF8C00; border-color: #FF8C00; color: var(--bg); }
    .f0.on    { background: #444;    border-color: #555;    color: #ccc; }
    .filter-sep { width: 1px; height: 20px; background: var(--afaint); flex-shrink: 0; }

    .search-wrap { margin-left: auto; position: relative; flex-shrink: 0; }
    .search-input {
        font-family: var(--fbody); font-size: 11px;
        background: var(--bg2); border: 1px solid var(--afaint);
        color: var(--w); padding: 6px 28px 6px 10px; outline: none;
        transition: border-color 0.15s; width: 160px;
    }
    .search-input:focus { border-color: var(--adim); }
    .search-input::placeholder { color: rgba(255,255,255,0.25); }
    .search-icon { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); color: var(--adim); font-size: 13px; pointer-events: none; }
    @media (max-width: 540px) { .search-wrap { margin-left: 0; width: 100%; } .search-input { width: 100%; } }

    /* GRID */
    .grid-wrap { padding: 20px; max-width: 1100px; margin: 0 auto; }
    .result-count { font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: var(--adim); margin-bottom: 16px; }

    .grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 12px;
    }
    @media (max-width: 840px) { .grid { grid-template-columns: repeat(2,1fr); } }
    @media (max-width: 480px) { .grid { grid-template-columns: 1fr; } }

    /* CARD */
    .card {
        background: var(--bg2); border: 1px solid var(--afaint);
        display: flex; flex-direction: column; overflow: hidden;
        transition: transform 0.18s, border-color 0.18s;
    }
    .card:hover { transform: translateY(-2px); border-color: #3a2800; }

    .card-img {
        height: 160px; background: #0a0700;
        display: flex; align-items: center; justify-content: center;
        font-size: 48px; position: relative; overflow: hidden; flex-shrink: 0;
    }
    .card-img img { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    .card-img::after {
        content: ''; position: absolute; bottom: 0; left: 0; right: 0;
        height: 40px; background: linear-gradient(transparent, var(--bg2)); pointer-events: none;
    }

    /* Rating stamp */
    .stamp {
        position: absolute; top: 10px; right: 10px;
        font-family: var(--fhead); font-size: 11px; letter-spacing: 1px;
        padding: 3px 8px; z-index: 1; line-height: 1.3;
    }
    .s3 { background: #39FF14; color: #0d0900; }
    .s2 { background: #FFD000; color: #0d0900; }
    .s1 { background: #FF8C00; color: #0d0900; }
    .s0 { background: #333; color: #888; border: 1px solid #444; }

    .card-body { padding: 14px 16px 16px; display: flex; flex-direction: column; flex: 1; }
    .card-name { font-family: var(--fhead); font-size: 20px; letter-spacing: 2px; line-height: 1; margin-bottom: 3px; }
    .card-loc  { font-size: 9px; letter-spacing: 3px; text-transform: uppercase; color: var(--adim); margin-bottom: 12px; }
    .card-sep  { border: none; border-top: 1px solid var(--afaint); margin-bottom: 12px; }
    .card-text { font-size: 12px; line-height: 1.75; color: var(--wd); flex: 1; margin-bottom: 14px; }
    .card-foot {
        display: flex; justify-content: space-between; align-items: center;
        font-size: 9px; letter-spacing: 1px;
        padding-top: 10px; border-top: 1px solid var(--afaint); gap: 6px;
    }
    .card-handle { color: var(--green); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; min-width: 0; text-decoration: none; }
    .card-handle:hover { text-decoration: underline; }
    .card-price  { border: 1px solid var(--afaint); color: rgba(255,255,255,0.5); padding: 2px 6px; font-size: 8px; letter-spacing: 2px; flex-shrink: 0; }
    .card-date   { color: rgba(255,255,255,0.35); flex-shrink: 0; }

    /* STATES */
    .state {
        grid-column: 1 / -1;
        padding: 60px 20px;
        text-align: center;
        font-size: 12px; letter-spacing: 2px; color: var(--adim);
    }
    .state-icon { font-size: 40px; margin-bottom: 16px; line-height: 1; }
    .state-title { font-family: var(--fhead); font-size: 20px; letter-spacing: 3px; color: var(--amber); margin-bottom: 8px; }
    .state-body { font-size: 11px; line-height: 1.8; color: var(--adim); }
    .state-body a { color: var(--green); text-decoration: none; }
    .state-body a:hover { text-decoration: underline; }

    /* Spinner */
    .spinner {
        grid-column: 1 / -1;
        display: flex; flex-direction: column; align-items: center; gap: 16px;
        padding: 60px 20px; color: var(--adim); font-size: 11px; letter-spacing: 2px;
    }
    .spinner-ring {
        width: 32px; height: 32px;
        border: 2px solid var(--afaint);
        border-top-color: var(--amber);
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* FOOTER */
    footer {
        border-top: 1px solid var(--afaint); background: var(--bg2);
        padding: 24px 20px; display: flex; flex-wrap: wrap;
        justify-content: space-between; align-items: center;
        gap: 14px; font-size: 9px; letter-spacing: 1.5px; color: var(--adim);
        margin-top: 40px;
    }
    .footer-logo { font-family: var(--fhead); font-size: 18px; letter-spacing: 3px; color: var(--amber); }
    .footer-links { display: flex; gap: 16px; flex-wrap: wrap; }
    footer a { color: var(--adim); text-decoration: none; transition: color 0.15s; }
    footer a:hover { color: var(--w); }
    @media (max-width: 500px) { footer { flex-direction: column; align-items: flex-start; } }
    </style>
</head>
<body>

<nav>
    <a href="/" class="logo">CB<span class="bolt">âš¡</span>DB</a>
    <ul class="nav-links">
        <li><a href="/database.html" class="active">Database</a></li>
        <li class="hide"><a href="/format.html">Format</a></li>
        <li><a href="/reviewer.html" class="pill">Join</a></li>
    </ul>
</nav>

<div class="page-head">
    <div>
        <div class="eyebrow">â—ˆ Live index Â· #CBDB on Bluesky</div>
        <div class="page-title">THE BURGERS</div>
    </div>
    <div class="live-badge">
        <div class="live-dot"></div>
        Live from Bluesky
    </div>
</div>

<div class="filter-bar">
    <span class="filter-label">Filter:</span>
    <button class="fbtn fall on" onclick="setFilter('all',this)">All</button>
    <button class="fbtn f3"     onclick="setFilter('3',this)">â­â­â­</button>
    <button class="fbtn f2"     onclick="setFilter('2',this)">â­â­</button>
    <button class="fbtn f1"     onclick="setFilter('1',this)">â­</button>
    <button class="fbtn f0"     onclick="setFilter('0',this)">ã„¨</button>
    <div class="filter-sep"></div>
    <button class="fbtn" id="yearBtn" onclick="toggleYear(this)">Last Year</button>
    <div class="search-wrap">
        <input class="search-input" id="q" type="text" placeholder="Search..." oninput="renderFiltered()">
        <span class="search-icon">âŒ•</span>
    </div>
</div>

<div class="grid-wrap">
    <div class="result-count" id="count"></div>
    <div class="grid" id="grid">
        <div class="spinner">
            <div class="spinner-ring"></div>
            Fetching from Bluesky...
        </div>
    </div>
</div>

<footer>
    <div class="footer-logo">CBâš¡DB</div>
    <div class="footer-links">
        <a href="/">Home</a>
        <a href="/format.html">Format Guide</a>
        <a href="https://github.com/cheeseburgerworld/cbdb" target="_blank">GitHub</a>
    </div>
    <div>Â© 2026 Cheeseburger World LLC</div>
</footer>

<script>
// â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Add approved Bluesky handles here (lowercase, no @)
const APPROVED = new Set([
    'cheeseburger.world',
    // add more approved handles here as the program grows
]);

const BSKY_API    = 'https://public.api.bsky.app/xrpc';
const FETCH_LIMIT = 100;

// â”€â”€ RATING MAPS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LABEL = {
    3: 'â­â­â­ Legendary',
    2: 'â­â­ Worth A Trip',
    1: 'â­ Solid',
    0: 'ã„¨ Skip It'
};
const STAMP_CLASS = { 3:'s3', 2:'s2', 1:'s1', 0:'s0' };
const NAME_COLOR  = { 3:'#39FF14', 2:'#FFD000', 1:'#FF8C00', 0:'#888' };

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let ALL_REVIEWS   = [];
let activeFilter  = 'all';
let yearOnly      = false;

// â”€â”€ FETCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Fetches each approved handle's feed directly â€” more reliable than search API
async function loadReviews() {
    ALL_REVIEWS = [];
    const errors = [];

    await Promise.all([...APPROVED].map(async handle => {
        try {
            const url  = `${BSKY_API}/app.bsky.feed.getAuthorFeed?actor=${encodeURIComponent(handle)}&limit=${FETCH_LIMIT}&filter=posts_no_replies`;
            const res  = await fetch(url);
            if (!res.ok) throw new Error(`HTTP ${res.status} for ${handle}`);
            const data = await res.json();
            const feed = data.feed || [];

            for (const item of feed) {
                const post = item.post;
                if (!post) continue;

                const text = post.record?.text || '';
                if (!/\#CBDB/i.test(text)) continue;

                const parsed = parsePost(text);
                if (!parsed) continue;

                ALL_REVIEWS.push({
                    restaurant: parsed.restaurant,
                    location:   parsed.location,
                    r:          parsed.ratingNum,
                    price:      parsed.price,
                    notes:      parsed.reviewText,
                    handle:     post.author?.handle || handle,
                    date:       formatDate(post.record?.createdAt),
                    imageUrl:   extractImage(post),
                    postUrl:    buildPostUrl(post.author?.handle || handle, post.uri),
                    _ts:        post.record?.createdAt || '',
                });
            }
        } catch(err) {
            errors.push(err);
            console.warn(`Failed to fetch feed for ${handle}:`, err);
        }
    }));

    // Sort newest first
    ALL_REVIEWS.sort((a, b) => b._ts.localeCompare(a._ts));

    if (ALL_REVIEWS.length === 0 && errors.length === APPROVED.size) {
        showError(errors[0]);
        return;
    }

    renderFiltered();
}

// â”€â”€ PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Format:
//   Line 0: Restaurant name
//   Line 1: City, State
//   Line 2: Rating (â­ / â­â­ / â­â­â­ / ã„¨)
//   Line 3: Price ($ / $$ / $$$)
//   Line 4: blank
//   Line 5+: Review text
//   blank
//   #CBDB
function parsePost(text) {
    if (!text || !/\#CBDB/i.test(text)) return null;

    const lines = text.replace(/\r/g, '').split('\n');
    if (lines.length < 6) return null;

    const restaurant = lines[0].trim();
    const location   = lines[1].trim();
    const ratingLine = lines[2].trim();
    const priceLine  = lines[3].trim();

    if (!restaurant || restaurant.startsWith('#')) return null;
    if (!location || !location.includes(','))       return null;

    const rating = parseRating(ratingLine);
    if (!rating) return null;

    const price = (priceLine.match(/^(\${1,3})/) || [])[1] || '';

    // Collect review lines after line 3 (skipping leading blank, stopping at blank or #CBDB)
    const afterMeta   = lines.slice(4);
    const reviewLines = [];
    let inReview = false;

    for (const line of afterMeta) {
        const t = line.trim();
        if (/^#CBDB/i.test(t)) break;
        if (!inReview && t === '') continue;
        inReview = true;
        if (t === '') break;
        reviewLines.push(line);
    }

    const reviewText = reviewLines.join('\n').trim();
    if (!reviewText) return null;

    return {
        restaurant,
        location,
        ratingNum:   rating.num,
        ratingLabel: rating.label,
        price,
        reviewText
    };
}

function parseRating(line) {
    const stars = (line.match(/â­/g) || []).length;
    const skip  = stars === 0 && /^[ã„¨âœ—Xx]/.test(line);
    if (skip)              return { num: 0, label: 'ã„¨ Skip It' };
    if (stars >= 1 && stars <= 3) {
        const labels = { 1:'â­ Solid', 2:'â­â­ Worth A Trip', 3:'â­â­â­ Legendary' };
        return { num: stars, label: labels[stars] };
    }
    return null;
}

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function extractImage(post) {
    try {
        const embed = post.embed || post.record?.embed;
        if (!embed) return null;
        if (embed.images?.length)       return embed.images[0].thumb || embed.images[0].fullsize || null;
        if (embed.media?.images?.length) return embed.media.images[0].thumb || null;
    } catch(e) {}
    return null;
}

function buildPostUrl(handle, uri) {
    if (!handle || !uri) return '#';
    const id = uri.split('/').pop();
    return `https://bsky.app/profile/${handle}/post/${id}`;
}

function formatDate(iso) {
    if (!iso) return '';
    const d = new Date(iso);
    return d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
}

function parseReviewDate(dateStr) {
    if (!dateStr) return null;
    const d = new Date(dateStr);
    return isNaN(d.getTime()) ? null : d;
}

function showError(err) {
    console.error(err);
    document.getElementById('count').textContent = '';
    document.getElementById('grid').innerHTML = `
        <div class="state">
            <div class="state-icon">âš ï¸</div>
            <div class="state-title">COULD NOT LOAD</div>
            <div class="state-body">
                Couldn't reach Bluesky. Check your connection and try refreshing.<br>
                <a href="https://bsky.app/hashtag/CBDB" target="_blank">View #CBDB posts directly on Bluesky â†’</a>
            </div>
        </div>`;
}

// â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setFilter(val, btn) {
    activeFilter = val;
    document.querySelectorAll('.fbtn:not(#yearBtn)').forEach(b => b.classList.remove('on'));
    btn.classList.add('on');
    renderFiltered();
}

function toggleYear(btn) {
    yearOnly = !yearOnly;
    btn.classList.toggle('on', yearOnly);
    renderFiltered();
}

function renderFiltered() {
    const q          = (document.getElementById('q').value || '').toLowerCase().trim();
    const oneYearAgo = new Date();
    oneYearAgo.setFullYear(oneYearAgo.getFullYear() - 1);

    const list = ALL_REVIEWS.filter(r => {
        const rOk = activeFilter === 'all' || String(r.r) === activeFilter;
        const qOk = !q
            || r.restaurant.toLowerCase().includes(q)
            || r.location.toLowerCase().includes(q)
            || r.notes.toLowerCase().includes(q);
        const yOk = !yearOnly || (() => {
            const d = parseReviewDate(r.date);
            return d && d >= oneYearAgo;
        })();
        return rOk && qOk && yOk;
    });

    render(list);
}

// â”€â”€ RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(list) {
    const grid  = document.getElementById('grid');
    const count = document.getElementById('count');

    if (ALL_REVIEWS.length === 0) {
        count.textContent = '';
        grid.innerHTML = `
            <div class="state">
                <div class="state-icon">ğŸ”</div>
                <div class="state-title">NO REVIEWS YET</div>
                <div class="state-body">
                    Nothing indexed yet. Post to Bluesky using #CBDB<br>
                    and it'll show up here within the hour.<br><br>
                    <a href="/format.html">See the post format â†’</a>
                </div>
            </div>`;
        return;
    }

    count.textContent = list.length + ' review' + (list.length !== 1 ? 's' : '');

    if (!list.length) {
        grid.innerHTML = `<div class="state"><div class="state-body">No reviews match â€” try a different filter.</div></div>`;
        return;
    }

    grid.innerHTML = list.map(r => `
        <div class="card">
            <div class="card-img">
                ${r.imageUrl ? `<img src="${r.imageUrl}" alt="${r.restaurant}" loading="lazy">` : 'ğŸ”'}
                <div class="stamp ${STAMP_CLASS[r.r]}">${LABEL[r.r]}</div>
            </div>
            <div class="card-body">
                <div class="card-name" style="color:${NAME_COLOR[r.r]}">${r.restaurant}</div>
                <div class="card-loc">${r.location}</div>
                <hr class="card-sep">
                <div class="card-text">${r.notes}</div>
                <div class="card-foot">
                    <a class="card-handle" href="${r.postUrl}" target="_blank" rel="noopener">@${r.handle}</a>
                    ${r.price ? `<span class="card-price">${r.price}</span>` : ''}
                    <span class="card-date">${r.date}</span>
                </div>
            </div>
        </div>
    `).join('');
}

// â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loadReviews();
</script>
</body>
</html>
